#!/usr/bin/env sh
echo -ne "
__________________________________________________________________________________________________________
|                                                                                                         |
|                       +-+-+-+-+-+        +-+-+-+-+-+        +-+-+-+-+-+-+-+-+-+                         |
|                       |M|a|g|i|c|        |M|e|t|i|s|        |I|n|s|t|a|l|l|e|r|                         |
|                       +-+-+-+-+-+        +-+-+-+-+-+        +-+-+-+-+-+-+-+-+-+                         |
|                                                                                                         |
|---------------------------------------------------------------------------------------------------------|
|                                 Official Cli installer for metis linux.                                 |
|---------------------------------------------------------------------------------------------------------|
|                                 Install Metis Linus in few clicks                                       |
|               Check: https://github.com/metis-os for details or visit https://metislinux.org            |
|---------------------------------------------------------------------------------------------------------|
|_________________________________________________________________________________________________________|

"
sleep 3s
echo "Internet Connection is a must to begin."
echo "Installing terminus font for better view."
pacman -Sy --needed --noconfirm terminus-font
setfont ter-v22b
sleep 2s
clear

echo -ne "
------------------------------------------------------------------------
        THIS WILL FORMAT AND DELETE ALL DATA ON THE DISK
      Please make sure you know what you are doing because
    after formating your disk there is no way to get data back
------------------------------------------------------------------------
"
sleep 3s
lsblk
echo "Enter the drive to install metis linux on it."
echo "Enter Drive (eg. sda or vda or nvme0n1): "
read -r drive
sleep 2s
clear

lsblk
echo "Choose a familier disk utility tool to partition your drive!"
echo " 1. fdisk"
echo " 2. cfdisk"
echo " 3. gdisk"
echo " 4. parted"
read -r partitionutility

case "$partitionutility" in
  1 | fdisk | Fdisk | FDISK)
  partitionutility="fdisk"
  ;;
  2 | cfdisk | Cfdisk | CFDISK)
  partitionutility="cfdisk"
  ;;
  3 | gdisk | Gdisk | GDISK)
  partitionutility="gdisk"
  ;;
  4 | parted | Parted | PARTED)
  partitionutility="parted"
  ;;
  *)
  echo "Unknown or unsupported disk utility! Default = cfdisk."
  partitionutility="cfdisk"
  ;;
esac
echo "$partitionutility is the selected disk utility tool for partition."
sleep 3s
clear
echo "Getting ready for creating partitions!"
echo "boot partition is mandatory for uefi systems. Skip it for legacy systems"
echo "root partition is mandatory."
echo "home and swap partitions are optional but recommended!"
echo "Also, you can create a separate partition for timeshift backup (optional)!"
echo "Getting ready in 15 seconds"
sleep 15s
"$partitionutility" /dev/"$drive"
clear
lsblk
echo " 1. ext4"
echo " 2. xfs"
echo " 3. btrfs"
echo " 4. f2fs"
echo " Boot partition will be formatted later in fat32 file system type if you have created one."
echo "choose your linux file system type for formatting drives: "
read -r filesystemtype

case "$filesystemtype" in
  1 | ext4 | Ext4 | EXT4)
  filesystemtype="ext4"
  ;;
  2 | xfs | Xfs | XFS)
  filesystemtype="xfs"
  ;;
  3 | btrfs | Btrfs | BTRFS)
  filesystemtype="btrfs"
  ;;
  4 | f2fs | F2fs | F2FS)
  filesystemtype="f2fs"
  ;;
  *)
  echo "Unknown or unsupported Filesystem. Default = ext4."
  filesystemtype="ext4"
  ;;
esac
echo "$filesystemtype is the selected file system type."
sleep 3s
clear
echo "Getting ready for formatting drives."
sleep 3s
lsblk
echo "Enter the root partition (eg: sda1 or nvme0n1p2 or vda4): "
read -r rootpartition
mkfs."$filesystemtype" /dev/"$rootpartition"
mount /dev/"$rootpartition" /mnt
clear
lsblk
read -p "Did you also create separate home partition? [y/n]: " answerhome
case "$answerhome" in
  y | Y | yes | Yes | YES)
  echo "Enter home partition (eg: sda2 or nvme0n1p1 or vda2): "
  read -r homepartition
  mkfs."$filesystemtype" /dev/"$homepartition"
  mkdir /mnt/home
  mount /dev/"$homepartition" /mnt/home
  ;;
  *)
  echo "Skipping home partition!"
  ;;
esac
clear
lsblk
read -p "Did you also create swap partition? [y/n]: " answerswap
case "$answerswap" in
  y | Y | yes | Yes | YES)
  echo "Enter swap partition (eg: sda3, nvme0n1p1or vda3): "
  read -r swappartition
  mkswap /dev/"$swappartition"
  swapon /dev/"$swappartition"
  ;;
  *)
  echo "Skipping Swap partition!"
  ;;
esac

clear
lsblk
sleep 3s
clear
echo "Installing Base system"
sleep 2s
basestrap /mnt base base-devel runit elogind-runit
sleep 2s
echo "Installing Kernel"
 basestrap /mnt linux-zen linux-firmware linux-zen-headers
clear
echo "generating fstab file"
fstabgen -U /mnt > /mnt/etc/fstab
sleep 1s
clear
echo "Checking Fstab Contents"
cat /mnt/etc/fstab
sleep 2s
echo "Copying config files to new system"
cp /usr/bin/artix-chroot /usr/bin/metis-chroot
cp /usr/local/bin/post_install.sh /mnt
cp /usr/local/bin/os-release /mnt
cp /usr/local/bin/grub /mnt
cp /usr/local/bin/xinitrc /mnt
cp /usr/local/bin/pacman.conf /mnt
cp /usr/local/bin/mirrorlist /mnt
cp /usr/local/bin/metis-mirrorlist /mnt
cp /usr/local/bin/init.vim /mnt
cp /usr/local/bin/zshrc /mnt
cp /usr/local/bin/picom.conf /mnt
echo "Checking configs in system"
ls /mnt
sleep 5s
clear
echo "First Phase Completed!"
echo "Entering into Second Phase of Installation..."
echo "run the following command to start second phase"
echo "1. metis-chroot /mnt"
echo "2. ./post_install.sh"